# 라이브러리 개선 로드맵

## 문제 분석 요약

### ProtocolTest 문제: ✅ 테스트 코드 문제 (해결됨)
- **원인**: enum 값(uint16_t)을 uint8_t로 캐스팅할 때의 동작을 제대로 이해하지 못함
- **해결**: 테스트 코드 수정 완료
- **라이브러리 동작**: 의도대로 정상 동작

### EchoTest 문제: ⚠️ **라이브러리 문서화 부족 + 테스트 코드 사용법 오류**
- **원인**: 
  - 라이브러리 측: `client_start_chat()`가 블로킹 함수인데 헤더 파일에 명시되지 않음
  - 테스트 코드 측: 블로킹 함수를 메인 스레드에서 호출
- **해결**: 테스트 코드 수정 완료
- **라이브러리 개선 필요**: 문서화 추가 (완료)

---

## 이후 개선 계획

### 단기 (즉시 개선) ✅

#### 1. API 문서화 개선 ✅ (완료)
- [x] `client_start_chat()` 함수에 블로킹 동작 명시
- [x] `message_type_t` enum에 uint8_t 캐스팅 동작 경고 추가
- [x] 사용 예제 추가

#### 2. 테스트 코드 개선 ✅ (완료)
- [x] ProtocolTest 수정 (enum 값 비교 문제)
- [x] EchoTest 수정 (블로킹 함수 스레드 처리)
- [ ] VLA 경고 제거 (command_queue_test.c)

---

### 중기 (1-2주 내)

#### 3. enum 값 범위 개선 (중요도: 높음)
**현재 문제**: 
- `MSG_TYPE_PING = 900`, `MSG_TYPE_PONG = 901`은 uint8_t 범위(0-255)를 초과
- 프레임에 저장 시 하위 바이트만 저장되어 혼란 발생

**개선 방안**:
```c
// 옵션 1: enum 값 범위를 uint8_t 내로 제한 (권장)
typedef enum {
    // ... 기존 값들 ...
    MSG_TYPE_PING = 250,  // 900 → 250
    MSG_TYPE_PONG = 251,  // 901 → 251
} message_type_t;

// 옵션 2: uint16_t 사용 (프로토콜 변경 필요)
// 헤더 크기 변경: 5바이트 → 6바이트
```

**영향도**:
- 옵션 1: 하위 호환성 깨짐 (프로토콜 버전 관리 필요)
- 옵션 2: 프로토콜 변경으로 인한 큰 변경

**권장사항**: 
- 옵션 1 선택 + 프로토콜 버전 필드 추가

#### 4. 테스트 커버리지 확대

**추가할 테스트**:
- [ ] socket_utils 모듈 테스트
  - `create_tcp_socket()` 성공/실패
  - `set_socket_reusable()` 검증
  - `close_socket()` 검증

- [ ] 에러 처리 테스트
  - NULL 포인터 처리
  - 잘못된 인자 처리
  - 메모리 부족 상황

- [ ] 경계값 테스트
  - 최대 클라이언트 수
  - 최대 메시지 크기
  - 빈 메시지
  - 매우 큰 메시지

- [ ] 동시성 테스트
  - 다중 클라이언트 연결
  - 동시 메시지 전송
  - 브로드캐스트 스트레스 테스트

#### 5. 코드 품질 개선

**컴파일 경고 제거**:
- [ ] VLA 경고 제거 (command_queue_test.c)
- [ ] 모든 경고 수준 확인

**메모리 안전성**:
- [ ] Valgrind를 통한 메모리 릭 검사
- [ ] Use-after-free 검사
- [ ] Double-free 검사
- [ ] 초기화되지 않은 메모리 접근 검사

**정적 분석**:
- [ ] Clang Static Analyzer 실행
- [ ] cppcheck 실행
- [ ] 발견된 문제 수정

---

### 장기 (1개월 내)

#### 6. 프로토콜 개선

**프로토콜 버전 관리 추가**:
```
헤더 구조 변경:
[1바이트: 버전] [1바이트: 타입] [4바이트: 길이]
```

**헤더 개선**:
- 버전 필드 추가 (하위 호환성 지원)
- 체크섬 필드 추가 (선택사항)
- 플래그 필드 추가 (압축, 암호화 등)

#### 7. 성능 최적화

**프로파일링**:
- [ ] CPU 프로파일링 (gprof, perf)
- [ ] 메모리 프로파일링
- [ ] 네트워크 I/O 최적화

**최적화 대상**:
- 메모리 복사 최소화
- 버퍼 크기 튜닝
- poll() 대신 epoll/kqueue 사용 고려 (Linux/macOS)

#### 8. 추가 기능

**보안**:
- [ ] TLS/SSL 지원
- [ ] 인증 토큰
- [ ] 메시지 암호화

**모니터링**:
- [ ] 통계 수집 (메시지 수, 연결 수 등)
- [ ] 로깅 시스템
- [ ] 헬스체크 API

---

## 즉시 조치 사항 (우선순위 순)

### 1. VLA 경고 제거 ⚠️ (즉시)
- `command_queue_test.c`의 VLA를 동적 할당으로 변경

### 2. enum 값 범위 검토 및 문서화 ✅ (완료)
- 현재 상태로 문서화 완료
- 향후 버전에서 개선 필요성 명시

### 3. 추가 단위 테스트 작성 (1주일 내)
- socket_utils 테스트
- 에러 처리 테스트

### 4. 메모리 안전성 검사 (1주일 내)
- Valgrind 실행
- 발견된 문제 수정

---

## 기술 부채 정리

### 현재 알려진 이슈

1. **enum 값 범위 문제** (낮은 우선순위)
   - 영향: 일부 메시지 타입이 예상과 다르게 동작
   - 해결: 문서화 완료, 향후 버전에서 수정 예정

2. **API 문서화 부족** (해결됨 ✅)
   - `client_start_chat()` 블로킹 동작 명시 완료

3. **테스트 커버리지 부족** (중간 우선순위)
   - 일부 모듈(socket_utils) 테스트 없음
   - 에러 처리 시나리오 부족

---

## 다음 단계

1. ✅ **완료**: API 문서화 개선
2. 🔄 **진행 중**: VLA 경고 제거
3. 📋 **계획**: 추가 테스트 작성
4. 📋 **계획**: 메모리 안전성 검사
5. 📋 **계획**: enum 값 범위 개선 (향후 버전)
